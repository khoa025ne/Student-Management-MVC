@model IEnumerable<DataAccess.Entities.Enrollment>

@{
    ViewData["Title"] = "Lịch học của tôi";
    var activeEnrollments = Model.Where(e => e.Status == "Active" || e.Status == "Enrolled").ToList();
    var totalCredits = activeEnrollments.Sum(e => e.Class?.Course?.Credits ?? 0);
    
    var currentWeek = ViewBag.CurrentWeek ?? 1;
    var totalWeeks = ViewBag.TotalWeeks ?? 16;
    var weekStartDate = ViewBag.WeekStartDate as DateTime?;
    var weekEndDate = ViewBag.WeekEndDate as DateTime?;
    var activeSemester = ViewBag.ActiveSemester as DataAccess.Entities.Semester;
    
    // Group by time slots for schedule grid
    var days = new[] { "Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7" };
    var dayNums = new[] { 1, 2, 3, 4, 5, 6 }; // Monday=1, Tuesday=2...Saturday=6
    var slots = new[] { "Slot1", "Slot2", "Slot3", "Slot4" };
    var slotTimes = new Dictionary<string, string> {
        { "Slot1", "7:00 - 9:15" },
        { "Slot2", "9:30 - 11:45" },
        { "Slot3", "12:30 - 14:45" },
        { "Slot4", "15:00 - 17:15" }
    };
    var dayColors = new[] { "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4" };
    
    // Helper function để map DayOfWeekPair to actual days
    Func<DataAccess.Enums.DayOfWeekPair, int[]> GetDaysFromPair = (pair) => {
        return pair switch {
            DataAccess.Enums.DayOfWeekPair.MonThu => new[] { 1, 4 }, // Monday, Thursday
            DataAccess.Enums.DayOfWeekPair.TueFri => new[] { 2, 5 }, // Tuesday, Friday
            DataAccess.Enums.DayOfWeekPair.WedSat => new[] { 3, 6 }, // Wednesday, Saturday
            _ => new int[] { }
        };
    };
}

<div class="space-y-6">
    <!-- Page Header -->
    <div class="page-header animate-fadeIn">
        <div>
            <h1><i class="fas fa-calendar-alt"></i>Lịch học của tôi</h1>
            <p>Xem thời khóa biểu và lịch học hàng tuần</p>
            @if (activeSemester != null)
            {
                <p class="small text-muted mt-1">
                    <i class="fas fa-calendar-check me-1"></i>
                    Học kỳ: <strong>@activeSemester.SemesterName</strong>
                    (@activeSemester.StartDate.ToString("dd/MM/yyyy") - @activeSemester.EndDate.ToString("dd/MM/yyyy"))
                </p>
            }
        </div>
        <a asp-controller="Enrollments" asp-action="Register" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Đăng ký thêm
        </a>
    </div>

    @if (!Model.Any())
    {
        <div class="glass-card">
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>Chưa có lịch học</h3>
                <p>Bạn chưa đăng ký lớp học nào. Hãy đăng ký môn học để xem lịch.</p>
                <a asp-controller="Enrollments" asp-action="Register" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Đăng ký môn học
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Week Selector -->
        <div class="glass-card">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div>
                    <h5 class="mb-1 fw-semibold">
                        <i class="fas fa-calendar-week me-2" style="color: var(--primary);"></i>
                        Tuần @currentWeek / @totalWeeks
                    </h5>
                    @if (weekStartDate.HasValue && weekEndDate.HasValue)
                    {
                        <p class="small text-muted mb-0">
                            <i class="fas fa-clock me-1"></i>
                            @weekStartDate.Value.ToString("dd/MM/yyyy") - @weekEndDate.Value.ToString("dd/MM/yyyy")
                        </p>
                    }
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a asp-action="Index" asp-route-week="@(currentWeek > 1 ? currentWeek - 1 : 1)" 
                       class="btn btn-sm @(currentWeek <= 1 ? "btn-secondary disabled" : "btn-outline-primary")">
                        <i class="fas fa-chevron-left"></i> Tuần trước
                    </a>
                    
                    <select id="weekSelector" class="form-select form-select-sm" style="width: auto;" onchange="changeWeek(this.value)">
                        @for (int w = 1; w <= totalWeeks; w++)
                        {
                            var isSelected = (w == currentWeek);
                            <option value="@w" selected="@isSelected">Tuần @w</option>
                        }
                    </select>
                    
                    <a asp-action="Index" asp-route-week="@(currentWeek < totalWeeks ? currentWeek + 1 : totalWeeks)" 
                       class="btn btn-sm @(currentWeek >= totalWeeks ? "btn-secondary disabled" : "btn-outline-primary")">
                        Tuần sau <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
        <!-- Stats Cards -->
        <div class="row g-4">
            <div class="col-6 col-md-3">
                <div class="stat-card animate-fadeIn">
                    <div class="stat-card-icon">
                        <i class="fas fa-chalkboard"></i>
                    </div>
                    <div>
                        <p class="stat-card-label">Tổng số lớp</p>
                        <p class="stat-card-value">@Model.Count()</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card animate-fadeIn" style="animation-delay: 0.1s;">
                    <div class="stat-card-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                        <i class="fas fa-book-reader"></i>
                    </div>
                    <div>
                        <p class="stat-card-label">Đang học</p>
                        <p class="stat-card-value">@activeEnrollments.Count()</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card animate-fadeIn" style="animation-delay: 0.2s;">
                    <div class="stat-card-icon" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <p class="stat-card-label">Tổng tín chỉ</p>
                        <p class="stat-card-value">@totalCredits</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card animate-fadeIn" style="animation-delay: 0.3s;">
                    <div class="stat-card-icon" style="background: rgba(251, 191, 36, 0.15); color: #f59e0b;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <p class="stat-card-label">Điểm TB</p>
                        @{
                            var scoredEnrollments = Model.Where(e => e.TotalScore.HasValue).ToList();
                            var avgScore = scoredEnrollments.Any() ? scoredEnrollments.Average(e => e.TotalScore!.Value) : 0;
                        }
                        <p class="stat-card-value">@(scoredEnrollments.Any() ? avgScore.ToString("0.1") : "N/A")</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Grid -->
        <div class="glass-card">
            <h5 class="mb-4 fw-semibold">
                <i class="fas fa-th me-2" style="color: var(--primary);"></i>Thời khóa biểu - Tuần @currentWeek
            </h5>
            <div class="schedule-grid-container">
                <div class="schedule-grid">
                    <!-- Header Row -->
                    <div class="schedule-header schedule-time-col">
                        <div class="fw-bold">Ca học</div>
                        <div class="small text-muted">Thời gian</div>
                    </div>
                    @for (int d = 0; d < days.Length; d++)
                    {
                        var dayDate = weekStartDate?.AddDays(d);
                        <div class="schedule-header" style="border-bottom: 3px solid @dayColors[d];">
                            <div class="fw-bold">@days[d]</div>
                            @if (dayDate.HasValue)
                            {
                                <div class="small text-muted">@dayDate.Value.ToString("dd/MM")</div>
                            }
                        </div>
                    }

                    <!-- Time Slots -->
                    @foreach (var slot in slots)
                    {
                        <div class="schedule-time">
                            <div class="schedule-slot-name">@slot</div>
                            <div class="schedule-slot-time">@slotTimes[slot]</div>
                        </div>
                        
                        @for (int d = 0; d < dayNums.Length; d++)
                        {
                            var dayNum = dayNums[d]; // 1=Monday, 2=Tuesday...
                            var matchingClasses = activeEnrollments
                                .Where(e => {
                                    if (e.Class == null) return false;
                                    var slotMatch = e.Class.TimeSlot.ToString() == slot;
                                    var dayPairDays = GetDaysFromPair(e.Class.DayOfWeekPair);
                                    var dayMatch = dayPairDays.Contains(dayNum);
                                    return slotMatch && dayMatch;
                                })
                                .ToList();
                            
                            <div class="schedule-cell">
                                @if (!matchingClasses.Any())
                                {
                                    <div class="schedule-empty">
                                        <i class="fas fa-moon text-muted" style="font-size: 1.5rem; opacity: 0.3;"></i>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var item in matchingClasses)
                                    {
                                        var slotIndex = Array.IndexOf(slots, slot);
                                        var itemColor = dayColors[d];
                                        <div class="schedule-item animate-fadeIn" style="background: linear-gradient(135deg, @(itemColor)22 0%, @(itemColor)11 100%); border-left: 3px solid @itemColor;">
                                            <div class="schedule-item-title">
                                                <i class="fas fa-book-open me-1"></i>
                                                @item.Class?.Course?.CourseName
                                            </div>
                                            <div class="schedule-item-detail">
                                                <i class="fas fa-map-marker-alt"></i> Phòng @item.Class?.Room
                                            </div>
                                            <div class="schedule-item-detail">
                                                <i class="fas fa-hashtag"></i> @item.Class?.ClassCode
                                            </div>
                                            <div class="schedule-item-detail">
                                                <i class="fas fa-clock"></i> @slotTimes[slot]
                                            </div>
                                            @if (item.Class?.Course?.Credits != null)
                                            {
                                                <div class="schedule-item-detail">
                                                    <i class="fas fa-graduation-cap"></i> @item.Class.Course.Credits TC
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Class List -->
        <div class="glass-card">
            <h5 class="mb-4 fw-semibold">
                <i class="fas fa-list me-2" style="color: var(--primary);"></i>Danh sách lớp học
            </h5>
            <div class="table-responsive">
                <table class="table-modern">
                    <thead>
                        <tr>
                            <th style="width: 5%;">STT</th>
                            <th>Lớp học</th>
                            <th>Phòng</th>
                            <th style="text-align: center;">Ngày</th>
                            <th style="text-align: center;">Ca học</th>
                            <th style="text-align: center;">Trạng thái</th>
                            <th style="text-align: center;">Điểm</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ int count = 1; }
                        @foreach (var enrollment in Model)
                        {
                            var statusClass = enrollment.Status == "Active" || enrollment.Status == "Enrolled" ? "success" : 
                                             enrollment.Status == "Completed" ? "primary" : "secondary";
                            var statusText = enrollment.Status == "Active" || enrollment.Status == "Enrolled" ? "Đang học" : 
                                            enrollment.Status == "Completed" ? "Hoàn thành" : enrollment.Status;
                            <tr class="animate-fadeIn">
                                <td class="text-center">@count</td>
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="stat-card-icon" style="width: 40px; height: 40px; font-size: 0.875rem;">
                                            <i class="fas fa-book"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">@enrollment.Class?.Course?.CourseName</div>
                                            <div class="small text-muted">@enrollment.Class?.ClassCode • @enrollment.Class?.Course?.Credits TC</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge-modern badge-secondary">
                                        <i class="fas fa-door-open me-1"></i>@enrollment.Class?.Room
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge-modern badge-info">
                                        @enrollment.Class?.DayOfWeekPair.ToString().Replace("_", "-")
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge-modern badge-warning">@enrollment.Class?.TimeSlot</span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge-modern badge-@statusClass">@statusText</span>
                                </td>
                                <td style="text-align: center;">
                                    @if (enrollment.TotalScore.HasValue)
                                    {
                                        var scoreClass = enrollment.IsPassed ? "success" : "danger";
                                        <span class="badge-modern badge-@scoreClass">@enrollment.TotalScore.Value.ToString("0.1")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">--</span>
                                    }
                                </td>
                            </tr>
                            count++;
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="glass-card">
            <h6 class="mb-3 fw-semibold">
                <i class="fas fa-info-circle me-2" style="color: var(--primary);"></i>Chú thích
            </h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <p class="small mb-2 fw-semibold">Ngày học:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge-modern badge-info">MonThu</span>
                            <span class="small text-muted">Thứ 2 & Thứ 5</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge-modern badge-info">TueFri</span>
                            <span class="small text-muted">Thứ 3 & Thứ 6</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge-modern badge-info">WedSat</span>
                            <span class="small text-muted">Thứ 4 & Thứ 7</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <p class="small mb-2 fw-semibold">Ca học:</p>
                    <div class="d-flex flex-wrap gap-3">
                        @foreach (var slot in slotTimes)
                        {
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge-modern badge-warning">@slot.Key</span>
                                <span class="small text-muted">@slot.Value</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script>
    function changeWeek(week) {
        window.location.href = '@Url.Action("Index", "Schedule")?week=' + week;
    }

    // Highlight today's column
    document.addEventListener('DOMContentLoaded', function() {
        @if (weekStartDate.HasValue && weekEndDate.HasValue)
        {
            @:var today = new Date();
            @:var weekStart = new Date(@weekStartDate.Value.Year, @(weekStartDate.Value.Month - 1), @weekStartDate.Value.Day);
            @:var weekEnd = new Date(@weekEndDate.Value.Year, @(weekEndDate.Value.Month - 1), @weekEndDate.Value.Day);
            @:
            @:if (today >= weekStart && today <= weekEnd) {
            @:    var dayOfWeek = today.getDay();
            @:    if (dayOfWeek >= 1 && dayOfWeek <= 6) {
            @:        var columnIndex = dayOfWeek;
            @:        var headers = document.querySelectorAll('.schedule-header');
            @:        
            @:        if (headers[columnIndex]) {
            @:            headers[columnIndex].style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
            @:            headers[columnIndex].innerHTML += '<div class="small mt-1"><i class="fas fa-calendar-day"></i> Hôm nay</div>';
            @:        }
            @:    }
            @:}
        }
    });
</script>

<style>
    .schedule-grid-container {
        overflow-x: auto;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .schedule-grid {
        display: grid;
        grid-template-columns: 140px repeat(6, 1fr);
        gap: 2px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        min-width: 1000px;
    }
    .schedule-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1.25rem;
        font-weight: 700;
        text-align: center;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }
    .schedule-time-col {
        background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 2px solid #e5e7eb;
    }
    .schedule-time {
        background: #fafbfc;
        padding: 1.25rem 0.75rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.375rem;
        border-right: 2px solid #e5e7eb;
        min-height: 140px;
    }
    .schedule-slot-name {
        font-weight: 800;
        font-size: 0.95rem;
        color: #2563eb;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .schedule-slot-time {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        white-space: nowrap;
    }
    .schedule-cell {
        background: #ffffff;
        padding: 0.75rem;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        transition: all 0.3s ease;
        position: relative;
    }
    .schedule-cell:hover {
        background: #f8fafc;
    }
    .schedule-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 120px;
        opacity: 0.3;
    }
    .schedule-item {
        padding: 0.875rem;
        border-radius: 10px;
        margin-bottom: 0.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    .schedule-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: currentColor;
        opacity: 0.8;
    }
    .schedule-item:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .schedule-item-title {
        font-weight: 700;
        font-size: 0.85rem;
        color: #1e293b;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        padding-left: 0.5rem;
    }
    .schedule-item-detail {
        font-size: 0.75rem;
        color: #475569;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding-left: 0.5rem;
        font-weight: 500;
    }
    .schedule-item-detail i {
        width: 14px;
        font-size: 0.7rem;
        opacity: 0.7;
    }

    /* Week selector styling */
    #weekSelector {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        background: var(--bg-card);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #weekSelector:hover {
        border-color: var(--primary);
    }
    #weekSelector:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .schedule-grid {
            grid-template-columns: 90px repeat(6, minmax(100px, 1fr));
        }
        .schedule-item-title {
            font-size: 0.7rem;
        }
        .schedule-item-detail {
            font-size: 0.65rem;
        }
    }
</style>
